# 🟡 DSR计算器中优先级功能实施讨论文档

**创建日期**: 2025-01-29
**状态**: ✅ 需求已确认 - 详见 `DSR-CALCULATOR-MEDIUM-PRIORITY-IMPLEMENTATION-PLAN.md`
**优先级**: 🟡 中优先级

> **注意**: 本文档为讨论阶段文档。最终确认的实施计划请查看 `DSR-CALCULATOR-MEDIUM-PRIORITY-IMPLEMENTATION-PLAN.md`

---

## 📋 总览

本文档用于讨论和规划以下3个中优先级功能的实施细节：

1. **收入计算增强**（津贴、自动计算所得税/SOCSO）
2. **债务管理增强**（更多类型、详情输入）
3. **结果导出功能**（PDF报告）

---

## 🎯 任务1: 收入计算增强

### 📊 当前状态分析

**现有实现**:
- ✅ 基本薪资输入 (`grossSalary`)
- ✅ EPF自动计算（8%）
- ⚠️ 所得税手动输入 (`incomeTax`)
- ⚠️ SOCSO手动输入 (`socso`)
- ❌ 无津贴输入
- ❌ 无奖金输入
- ❌ 无其他收入输入
- ❌ 无其他扣除输入

**代码位置**: `components/DSRCalculator.tsx` Step 2（约第292-361行）

### 🎨 功能需求详细讨论

#### 1.1 津贴输入功能

**需要讨论的问题**:

1. **津贴类型分类**:
   - 是否需要分类输入（如：交通津贴、住房津贴、餐饮津贴）？
   - 还是统一一个"固定津贴"字段即可？
   - **建议**: 先统一一个字段，后续可扩展

2. **津贴税务处理**:
   - 某些津贴可能免税（如：交通津贴RM 600/月免税）
   - 是否需要区分应税津贴和免税津贴？
   - **建议**: 第一阶段先不区分，统一计入总收入；第二阶段可添加免税津贴字段

3. **UI设计**:
   - 是否需要在Step 2中展开一个"高级选项"区域？
   - 还是直接显示所有字段？
   - **建议**: 使用折叠/展开设计，默认隐藏高级选项

#### 1.2 奖金输入功能

**需要讨论的问题**:

1. **奖金计算方式**:
   - 用户输入年奖金，系统自动除以12？
   - 还是用户直接输入月均奖金？
   - **建议**: 提供两种输入方式，用户选择

2. **奖金稳定性**:
   - 银行通常只认可稳定奖金（过去12个月一致）
   - 是否需要提示用户？
   - **建议**: 添加提示文本

#### 1.3 其他收入输入

**需要讨论的问题**:

1. **收入类型**:
   - 租金收入
   - 投资收入（股息、利息）
   - 副业收入
   - 其他收入
   - **建议**: 统一一个"其他收入"字段，或提供下拉选择

2. **收入认定**:
   - 不同银行对租金收入的认定率不同（通常50-70%）
   - 是否需要单独处理？
   - **建议**: 第一阶段统一计入，第二阶段可添加银行特定的收入认定规则

#### 1.4 其他扣除输入

**需要讨论的问题**:

1. **扣除类型**:
   - 保险费用（人寿、医疗）
   - 工会费
   - 其他固定扣除
   - **建议**: 统一一个字段即可

#### 1.5 自动计算所得税

**需要讨论的问题**:

1. **计算复杂度**:
   - 马来西亚所得税计算涉及：
     - 年度收入计算
     - 个人减免（Personal Relief）
     - 税率阶梯（0-30%）
     - 月度预扣（PCB）
   - **建议**: 使用简化计算或集成税务计算库

2. **数据需求**:
   - 需要2025年最新税率表
   - 需要个人减免标准
   - **建议**: 创建 `lib/malaysiaTaxCalculator.ts` 文件

3. **计算准确性**:
   - 是否需要100%准确？
   - 还是近似计算即可？
   - **建议**: 提供"估算"模式，用户可手动调整

4. **用户输入需求**:
   - 是否需要用户输入：
     - 婚姻状况（已婚/单身）
     - 子女数量
     - 其他减免项
   - **建议**: 第一阶段简化，只基于总收入估算；第二阶段可添加详细减免

#### 1.6 自动计算SOCSO

**需要讨论的问题**:

1. **SOCSO计算规则**:
   - 2025年SOCSO费率：
     - 员工：0.5% - 0.6%（根据薪资等级）
     - 雇主：1.75% - 1.95%
   - 薪资上限：RM 5,000/月
   - **建议**: 创建 `lib/socsoCalculator.ts` 文件

2. **计算准确性**:
   - SOCSO计算相对简单，可以实现100%准确
   - **建议**: 实现完整计算

### 💻 技术实施方案

#### 方案A: 渐进式增强（推荐）

**阶段1**: 添加基础字段
- 添加津贴、奖金、其他收入、其他扣除字段
- 更新净收入计算逻辑
- 更新UI显示

**阶段2**: 自动计算SOCSO
- 创建SOCSO计算函数
- 集成到收入计算中

**阶段3**: 自动计算所得税（简化版）
- 创建简化所得税计算函数
- 基于总收入估算

**阶段4**: 自动计算所得税（完整版）
- 添加个人减免输入
- 实现完整税务计算

#### 方案B: 一次性完整实现

- 所有功能同时实现
- 需要更多开发时间
- 测试复杂度更高

**建议**: 采用方案A，分阶段实施

### 📐 UI/UX设计建议

```
Step 2: 收入信息
├── 基本收入（默认展开）
│   ├── 月度总薪资
│   ├── EPF扣除（自动计算）
│   └── 净收入显示
│
├── 高级选项（默认折叠，点击展开）
│   ├── 固定津贴
│   ├── 月均奖金
│   ├── 其他收入
│   └── 其他扣除
│
└── 自动计算选项（可选）
    ├── [ ] 自动计算SOCSO
    └── [ ] 自动计算所得税（估算）
```

### 📦 需要创建的新文件

1. `lib/malaysiaTaxCalculator.ts` - 所得税计算
2. `lib/socsoCalculator.ts` - SOCSO计算
3. `lib/incomeCalculator.ts` - 收入计算辅助函数（可选）

### ⏱️ 预估工作量

- **阶段1**（基础字段）: 2-3小时
- **阶段2**（SOCSO自动计算）: 1-2小时
- **阶段3**（所得税简化）: 2-3小时
- **阶段4**（所得税完整）: 3-4小时
- **总计**: 8-12小时

---

## 🎯 任务2: 债务管理增强

### 📊 当前状态分析

**现有实现**:
- ✅ 房贷月供 (`housingLoan`)
- ✅ 车贷月供 (`autoLoan`)
- ✅ 个人贷款月供 (`personalLoan`)
- ✅ PTPTN月供 (`ptptn`)
- ✅ 信用卡管理（多张，动态添加/移除）
- ❌ 无其他债务类型
- ❌ 无债务详情输入（利率、期限等）

**代码位置**: `components/DSRCalculator.tsx` Step 3（约第363-482行）

### 🎨 功能需求详细讨论

#### 2.1 新增债务类型

**需要讨论的问题**:

1. **需要添加哪些债务类型？**
   - 商业贷款（Business Loan）
   - 透支额度（Overdraft）
   - 分期付款（Installment）
   - 其他债务（Other Debt）
   - **建议**: 添加"其他债务"动态管理功能

2. **债务类型优先级**:
   - 哪些是常见类型，需要单独字段？
   - 哪些可以归入"其他债务"？
   - **建议**:
     - 保留现有4种固定类型
     - 添加"其他债务"动态列表

#### 2.2 债务详情输入

**需要讨论的问题**:

1. **需要哪些详情字段？**
   - 债务名称/描述
   - 债务总额
   - 利率
   - 还款期限
   - 每月还款额
   - 剩余期数
   - **建议**: 至少需要"债务名称"和"每月还款额"

2. **详情输入方式**:
   - 每个债务类型都显示详情输入？
   - 还是点击"详情"按钮展开？
   - **建议**: 使用折叠设计，默认只显示月供，点击展开详情

3. **自动计算**:
   - 如果用户输入总额、利率、期限，是否自动计算月供？
   - **建议**: 提供"计算器"按钮，但不强制

#### 2.3 "其他债务"动态管理

**需要讨论的问题**:

1. **UI设计**:
   - 类似信用卡的添加/移除方式？
   - 还是使用表格形式？
   - **建议**: 使用卡片列表，类似信用卡管理

2. **数据结构**:
   ```typescript
   interface OtherDebt {
     id: string;
     name: string;
     monthlyPayment: number;
     // 可选详情
     totalAmount?: number;
     interestRate?: number;
     remainingMonths?: number;
   }
   ```

3. **数量限制**:
   - 是否需要限制"其他债务"的数量？
   - **建议**: 不限制，但UI上限制最多显示5-10个

### 💻 技术实施方案

#### 数据结构设计

```typescript
// 现有债务类型（保持不变）
const [housingLoan, setHousingLoan] = useState(0);
const [autoLoan, setAutoLoan] = useState(0);
const [personalLoan, setPersonalLoan] = useState(0);
const [ptptn, setPtptn] = useState(0);
const [creditCards, setCreditCards] = useState<Array<{ used: number; limit: number }>>([]);

// 新增：其他债务
interface OtherDebt {
  id: string;
  name: string;
  monthlyPayment: number;
  totalAmount?: number;
  interestRate?: number;
  remainingMonths?: number;
  notes?: string;
}

const [otherDebts, setOtherDebts] = useState<OtherDebt[]>([]);
```

#### 计算逻辑更新

```typescript
// 计算总承诺（更新）
useEffect(() => {
  let total = housingLoan + autoLoan + personalLoan + ptptn;

  // 信用卡
  creditCards.forEach(card => {
    total += card.used * 0.05; // 5%规则
  });

  // 其他债务
  otherDebts.forEach(debt => {
    total += debt.monthlyPayment;
  });

  setTotalCommitments(total);
}, [housingLoan, autoLoan, personalLoan, ptptn, creditCards, otherDebts]);
```

### 📐 UI/UX设计建议

```
Step 3: 现有债务
├── 固定债务类型（保持现有设计）
│   ├── 房贷月供
│   ├── 车贷月供
│   ├── 个人贷款月供
│   └── PTPTN月供
│
├── 信用卡管理（保持现有设计）
│   └── [添加信用卡] 按钮
│
└── 其他债务（新增）
    ├── 债务列表（卡片形式）
    │   ├── 债务1: [名称] - RM [月供]
    │   │   └── [详情] [删除]
    │   └── 债务2: ...
    │
    └── [+ 添加其他债务] 按钮
        └── 弹出表单：
            ├── 债务名称 *
            ├── 每月还款额 *
            ├── 债务总额（可选）
            ├── 利率（可选）
            ├── 剩余期数（可选）
            └── 备注（可选）
```

### ⏱️ 预估工作量

- **数据结构设计**: 1小时
- **UI组件开发**: 3-4小时
- **计算逻辑更新**: 1小时
- **测试验证**: 1-2小时
- **总计**: 6-8小时

---

## 🎯 任务3: 结果导出功能（PDF报告）

### 📊 当前状态分析

**现有实现**:
- ✅ 结果在页面上显示
- ✅ 银行对比表
- ✅ 推荐银行列表
- ❌ 无导出功能

**代码位置**: `components/DSRCalculator.tsx` Step 4（结果展示部分）

### 🎨 功能需求详细讨论

#### 3.1 PDF报告内容

**需要讨论的问题**:

1. **报告应该包含哪些内容？**
   - ✅ 用户基本信息（身份、就业类型）
   - ✅ 收入明细（总收入、扣除、净收入）
   - ✅ 债务明细（所有债务类型）
   - ✅ 贷款需求（类型、金额、期限、利率）
   - ✅ DSR计算结果
   - ✅ 银行对比表（15家银行）
   - ✅ 推荐银行列表
   - ✅ 改善建议（如果有）
   - **建议**: 包含以上所有内容

2. **报告格式**:
   - 单页报告还是多页报告？
   - **建议**: 多页报告，内容清晰分段

3. **报告语言**:
   - 支持多语言（EN/ZH/MS）？
   - **建议**: 根据用户选择的语言生成

#### 3.2 PDF生成技术方案

**需要讨论的问题**:

1. **技术选型**:
   - **选项A**: `react-pdf` / `@react-pdf/renderer`
     - 优点: React组件方式，易用
     - 缺点: 样式限制
   - **选项B**: `jspdf` + `html2canvas`
     - 优点: 可以转换现有HTML
     - 缺点: 可能样式丢失
   - **选项C**: `puppeteer` (服务端)
     - 优点: 完美渲染
     - 缺点: 需要服务端支持
   - **建议**: 使用选项A（`@react-pdf/renderer`），适合React项目

2. **文件大小**:
   - 是否需要压缩PDF？
   - **建议**: 默认不压缩，保持清晰度

3. **下载方式**:
   - 直接下载还是预览后下载？
   - **建议**: 直接下载，文件名包含日期

#### 3.3 报告模板设计

**需要讨论的问题**:

1. **报告样式**:
   - 是否需要品牌色彩？
   - 是否需要Logo？
   - **建议**: 使用品牌色彩，添加简单Logo

2. **报告布局**:
   ```
   第1页: 封面
   - 标题: DSR计算报告
   - 生成日期
   - 用户基本信息摘要

   第2页: 收入与债务详情
   - 收入明细表
   - 债务明细表

   第3页: 贷款需求与DSR结果
   - 贷款需求信息
   - DSR计算结果

   第4页: 银行对比分析
   - 15家银行对比表

   第5页: 推荐与建议
   - 推荐银行列表
   - 改善建议（如果有）
   ```

3. **数据可视化**:
   - 是否需要图表（如DSR分布图）？
   - **建议**: 第一阶段不包含图表，后续可添加

### 💻 技术实施方案

#### 安装依赖

```bash
npm install @react-pdf/renderer
```

#### 创建PDF组件

**文件**: `components/DSRReportPDF.tsx`

```typescript
import { Document, Page, Text, View, StyleSheet } from '@react-pdf/renderer';

interface DSRReportData {
  // 用户信息
  identityType: string;
  employmentType: string;
  // 收入信息
  grossSalary: number;
  netIncome: number;
  // 债务信息
  totalCommitments: number;
  // 贷款需求
  loanType: string;
  loanAmount: number;
  // 计算结果
  dsr: number;
  bankResults: any[];
  recommendations: any[];
}

export function DSRReportPDF({ data }: { data: DSRReportData }) {
  // PDF组件实现
}
```

#### 集成到DSR计算器

```typescript
// 在Step 4添加导出按钮
<button onClick={handleExportPDF}>
  <Download className="w-4 h-4 mr-2" />
  Export PDF Report
</button>

const handleExportPDF = () => {
  const reportData = {
    identityType,
    employmentType,
    grossSalary,
    netIncome,
    totalCommitments,
    loanType,
    loanAmount,
    dsr,
    bankResults,
    recommendations,
  };

  // 生成并下载PDF
  // ...
};
```

### 📐 UI/UX设计建议

```
Step 4: 结果页面
├── 结果摘要卡片
├── 银行对比表
├── 推荐银行列表
│
└── 操作按钮区域
    ├── [导出PDF报告] 按钮（主要）
    ├── [分享结果] 按钮（可选）
    └── [重新计算] 按钮
```

### 📦 需要创建的新文件

1. `components/DSRReportPDF.tsx` - PDF报告组件
2. `lib/pdfGenerator.ts` - PDF生成辅助函数（可选）
3. `styles/pdfStyles.ts` - PDF样式定义（可选）

### ⏱️ 预估工作量

- **PDF组件开发**: 4-5小时
- **数据整合**: 1-2小时
- **样式设计**: 2-3小时
- **测试验证**: 1-2小时
- **总计**: 8-12小时

---

## 📋 实施优先级建议

### 推荐顺序

1. **任务2: 债务管理增强** (6-8小时)
   - 相对简单
   - 用户价值高
   - 风险低

2. **任务1: 收入计算增强** (8-12小时)
   - 分阶段实施
   - 可以先做基础字段，后续添加自动计算

3. **任务3: PDF导出** (8-12小时)
   - 需要学习新库
   - 可以最后实施

### 分阶段实施计划

**第1周**: 债务管理增强
- 完成"其他债务"动态管理
- 添加债务详情输入

**第2-3周**: 收入计算增强
- 第2周：基础字段（津贴、奖金等）
- 第3周：自动计算SOCSO和所得税

**第4周**: PDF导出功能
- 开发PDF组件
- 集成到DSR计算器

---

## ❓ 需要确认的问题

### 关于收入计算增强

1. **津贴输入**: 是否需要区分应税和免税津贴？
2. **所得税计算**: 需要多准确？简化估算还是完整计算？
3. **个人减免**: 是否需要用户输入婚姻状况、子女数量等？

### 关于债务管理增强

1. **债务类型**: 是否需要添加更多固定债务类型，还是"其他债务"足够？
2. **详情输入**: 哪些字段是必需的，哪些是可选的？
3. **自动计算**: 是否需要根据总额、利率、期限自动计算月供？

### 关于PDF导出

1. **报告内容**: 是否需要包含所有15家银行的详细对比？
2. **报告样式**: 是否需要品牌Logo和特定颜色？
3. **多语言**: 是否需要支持多语言PDF？

---

## 🎯 下一步行动

1. **讨论确认**: 确认以上所有问题的答案
2. **技术选型**: 最终确定技术方案
3. **UI设计**: 确认UI/UX设计细节
4. **开始实施**: 按照优先级顺序开始开发

---

**文档状态**: 📋 待讨论确认
**最后更新**: 2025-01-29

